<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tomographer: Adding a new figure of merit to the \c tomorun program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="tomographer_extra_css.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Tomographer
   &#160;<span id="projectnumber">v4.1</span>
   </div>
   <div id="projectbrief">Tomographer C++ Framework Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_tomorun_new_figure_of_merit.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Adding a new figure of merit to the <code>tomorun</code> program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <code>tomorun</code> executable has several figures of merit built into the program: the trace distance, the purified distance, or the fidelity to any reference state, as well as the expectation value of an observable. If you wish to produce a histogram of a different figure of merit which can't be cast into one of these, you need to change the source code of the tomorun program.</p>
<p>Another option, which may be easier if you have a very special purpose which might not warrant inclusion into the generic <code>tomorun</code> program, is to combine the required classes into a new special-purpose program. This is not difficult, and there is already an example ready&mdash;see <a class="el" href="page_custom_tomorun_exe.html">Creating a custom tomorun-like program</a>.</p>
<p>This information page describes how you should change the source code of <code>tomorun</code> to include your figure of merit.</p>
<dl class="section note"><dt>Note</dt><dd>If you perform modifications which may be useful to others, please <b>fork the repository on github</b>, perform your changes, and send me a pull request. This way your changes will be availble to other users who would like to use the Tomographer project. Please see <a href="https://github.com/Tomographer/tomographer/blob/master/README.md#contributing">here</a> for information on how to contribute.</dd></dl>
<p>We'll illustrate these steps with a simple example: the two-norm distance (aka. the Hilbert-Schmidt distance) to any reference state, defined by \( d_\mathrm{HS}(\rho,\rho_{\mathrm{Ref}}) = \Vert \rho-\rho_{\mathrm{Ref}}\Vert_2 \), with \( \Vert A\Vert_2 = \mathrm{tr}\left(A^\dagger A\right) \).</p>
<h2>1. Code how to calculate your figure of merit</h2>
<p>First, you should write the code which calculates the figure of merit, complying to a <a class="el" href="page_interface_value_calculator.html">ValueCalculator Interface</a> type interface. Your new class should in particular have a method <code>getValue(const MatrixType &amp; T)</code> taking as argument an <a href="http://eigen.tuxfamily.org/dox/group__TutorialMatrixClass.html">Eigen matrix type</a> which will be a matrix square root (see <a class="el" href="page_params_t.html"><em>T</em> Parameterization</a>) of the quantum state <em>rho</em> for which the function should calculate the figure of merit.</p>
<p>You should do this in a new header file, that's the easiest.</p>
<p>For our example, we can get inspired by the code for, e.g., <a class="el" href="class_tomographer_1_1_dense_d_m_1_1_t_space_1_1_tr_dist_to_ref_calculator.html">Tomographer::DenseDM::TSpace::TrDistToRefCalculator</a> defined in <a class="el" href="tspacefigofmerit_8h.html">tspacefigofmerit.h</a>. For example, let's create a file called <code>"hs_dist.h"</code> inside the <code>"cxx/tomorun/"</code> directory of the tomographer project: </p><div class="fragment"><div class="line"><span class="preprocessor">#ifndef HS_DIST_H</span></div><div class="line"><span class="preprocessor">#define HS_DIST_H</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;Eigen/Eigen&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="needownoperatornew_8h.html">tomographer/tools/needownoperatornew.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dmtypes_8h.html">tomographer/densedm/dmtypes.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DMTypes_, <span class="keyword">typename</span> DistValueType_ = <span class="keywordtype">double</span>&gt;</div><div class="line"><span class="keyword">class </span>HSDistToRefCalculator</div><div class="line">  : <span class="keyword">public</span> <span class="keyword">virtual</span> <a class="code" href="struct_tomographer_1_1_tools_1_1_need_own_operator_new.html">Tomographer::Tools::NeedOwnOperatorNew</a>&lt;typename DMTypes_::MatrixType&gt;::ProviderType</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="keyword">typedef</span> DMTypes_ DMTypes;</div><div class="line">  <span class="comment">// this is the type to use to store a dense (dim x dim) matrix:</span></div><div class="line">  <span class="keyword">typedef</span> <span class="keyword">typename</span> DMTypes::MatrixType MatrixType;</div><div class="line">  <span class="keyword">typedef</span> <span class="keyword">typename</span> DMTypes::MatrixTypeConstRef MatrixTypeConstRef;</div><div class="line"></div><div class="line">  <span class="comment">// For the ValueCalculator interface: the value type</span></div><div class="line">  <span class="keyword">typedef</span> DistValueType_ ValueType;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keyword">const</span> MatrixType rho_ref;</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="comment">// Constructor, the reference state is &#39;rho_ref&#39;</span></div><div class="line">  TrDistToRefCalculator(MatrixTypeConstRef rho_ref_)</div><div class="line">    : rho_ref(rho_ref_)</div><div class="line">  {</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// This method actually calculates the given value.  The argument &quot;T&quot; is</span></div><div class="line">  <span class="comment">// the T-parameterization of the density matrix rho, which is simply a</span></div><div class="line">  <span class="comment">// square root of rho. (This is indeed the representation used during the</span></div><div class="line">  <span class="comment">// random walk.)</span></div><div class="line">  <span class="keyword">inline</span> ValueType getValue(MatrixTypeConstRef T)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="comment">// rho is obtained with T*T.adjoint().  With Eigen, the HS-norm (Frobenius) of a</span></div><div class="line">    <span class="comment">// matrix is given by A.norm().</span></div><div class="line">    <span class="keywordflow">return</span> (T*T.adjoint() - rho_ref).norm();</div><div class="line">  }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="preprocessor">#endif // HS_DIST_H</span></div></div><!-- fragment --><p>The part about <a class="el" href="needownoperatornew_8h.html">needownoperatornew.h</a> and <a class="el" href="struct_tomographer_1_1_tools_1_1_need_own_operator_new.html">Tomographer::Tools::NeedOwnOperatorNew</a> is to make sure that the object, when created, is aligned in memory. This is needed because the object has a Eigen member (<em>rho_ref</em>) which must be aligned in memory for vectorized operations (see Eigen's docs for alignment issues, there's a lot on that). In the <a class="el" href="namespace_tomographer.html" title="Base namespace for the Tomographer project. ">Tomographer</a> project, the <a class="el" href="struct_tomographer_1_1_tools_1_1_need_own_operator_new.html">Tomographer::Tools::NeedOwnOperatorNew</a> virtual base makes sure that the necessary <code>operator new()</code> is defined so that objects are aligned in memory when allocated.</p>
<h2>2. Declare the new figure of merit as command line option value</h2>
<p>The choice of figure of merit is specified as the argument to the command line option <code>"--value-type"</code>. So you should in fact first decide of a short memo string describing your figure of merit (e.g. for our example <code>"HS-dist"</code> would be an appropriate choice).</p>
<p>Now, open the file <code>"tomorun_opts.h"</code> located inside the <code>"cxx/tomorun/"</code> directory. The locations where you should adapt the code are marked by comments saying <code>"INSERT
CUSTOM FIGURE OF MERIT HERE"</code>. Adapt the code as follows.</p>
<p>The class <code>val_type_spec</code> is a type which is used to store the choice of figure of merit. It stores the choice as an enum value, but it is capable of converting to and from a string. So you should add a new enumeration value, as well as adapt the class methods, so that it understands your new figure of merit.</p>
<p>As with the other figures of merit, the user may also pass a string argument in the form <code>"HS-dist:string_argument_goes_here"</code> which can specify for example a reference state. You don't have to do anything special for that, it's taken care of for you already.</p>
<p>Also change the command-line help text to include documentation for your new figure of merit.</p>
<p>In our example, we'd change the following enumeration inside the class <code>val_type_spec</code> from: </p><div class="fragment"><div class="line"><span class="keyword">enum</span> ValueType {</div><div class="line">  INVALID = 0,</div><div class="line">  OBS_VALUE,</div><div class="line">  TR_DIST,</div><div class="line">  FIDELITY,</div><div class="line">  PURIF_DIST</div><div class="line">};</div></div><!-- fragment --><p> to: </p><div class="fragment"><div class="line"><span class="keyword">enum</span> ValueType {</div><div class="line">  INVALID = 0,</div><div class="line">  OBS_VALUE,</div><div class="line">  TR_DIST,</div><div class="line">  FIDELITY,</div><div class="line">  PURIF_DIST,</div><div class="line">  HS_DIST <span class="comment">// new figure of merit: HS distance to some reference state</span></div><div class="line">};</div></div><!-- fragment --><p> Then we would insert the following inside the method <em>val_type_spec::set_value_string()</em>, after the similar tests for the other figures of merit: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (valtype_str == <span class="stringliteral">&quot;HS-dist&quot;</span>) {</div><div class="line">  valtype = HS_DIST;</div><div class="line">  ref_obj_name = ref_obj_name_str; <span class="comment">// the reference state</span></div><div class="line">  <span class="keywordflow">return</span>;</div><div class="line">}</div></div><!-- fragment --><p> and similarly, we'd update the function <code>operator&lt;&lt;(<a class="elRef" doxygen="/Users/philippe/Research/projects/tomographer/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/io/basic_ostream.html" title="STL class. ">std::ostream</a> &amp; str, const val_type_spec &amp; val)</code> to include a case for our figure of merit: </p><div class="fragment"><div class="line"><span class="keywordflow">case</span> val_type_spec::HS_DIST:</div><div class="line">  str &lt;&lt; <span class="stringliteral">&quot;HS-dist&quot;</span>;</div><div class="line">  <span class="keywordflow">break</span>;</div></div><!-- fragment --><h2>3. Instruct <code>tomorun</code> how to instantiate your figure of merit calculator</h2>
<p>The final piece of code which needs to be added is the logic of how your class which calculates the figure of merit (in our example, inside <code>"hs_dist.h"</code>) should be instantiated.</p>
<p>The relevant file to modify is the file named <code>tomorun_dispatch.h</code>, located inside the <code>"cxx/tomorun/"</code> directory.</p>
<p>First, include your <code>"hs_dist.h"</code> file near the top: insert the line </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;hs_dist.h&quot;</span></div></div><!-- fragment --><p> near the top of the file, below the other include directives.</p>
<p>Then you'll have to code how specifically the program should instantiate your value calculator. Add a conditional in the function <code>tomorun_dispatch()</code> which tests whether the user asked for your figure of merit, and instantiate your class appropriately. The general logic should look like this: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (opt-&gt;valtype.valtype == val_type_spec::&lt;MY_CUSTOM_FIGURE_OF_MERIT&gt;) {</div><div class="line"></div><div class="line">  ... instantiate ValueCalculator and dispatch to tomorun&lt;...&gt;(...)  ...</div><div class="line"></div><div class="line">  <span class="comment">// Finally, dispatch the execution to tomorun&lt;&gt;(...):</span></div><div class="line">  tomorun&lt;BinningAnalysisErrorBars&gt;(</div><div class="line">      tomodat,            <span class="comment">// the TomoProblem instance</span></div><div class="line">      opt,                <span class="comment">// the program options</span></div><div class="line">      <span class="comment">// and our ValueCalculator instance:</span></div><div class="line">      MyCustomFigureOfMeritValueCalculator&lt;...&gt;(...),</div><div class="line">      logger); <span class="comment">// and finally the logger instance</span></div><div class="line">  <span class="keywordflow">return</span>;</div><div class="line">}</div></div><!-- fragment --><p>Starting in <a class="el" href="namespace_tomographer.html" title="Base namespace for the Tomographer project. ">Tomographer</a> version 2, the set up is slightly more complicated, because there are two different ways <code>tomorun</code> can be compiled. It can either be compiled by using a <a class="el" href="class_tomographer_1_1_multiplexor_value_calculator.html">Tomographer::MultiplexorValueCalculator</a>, or with static checks and different static code for each figure of merit (as before). The former approach seems more efficient, and is now the default (this can be changed with CMake options when compiling tomorun). The logic is not that compicated, so you're best off by seeing what the code does for the built-in figures of merit and mimicking that.</p>
<p>You're probably best off copying from the built-in examples inside that same function, or the example for the Hilbert-Schmidt distance presented here. Here are some additional tips:</p>
<ul>
<li>The object <code>"opt-&gt;valtype.ref_obj_name"</code> is an <a class="elRef" doxygen="/Users/philippe/Research/projects/tomographer/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/string/basic_string.html" title="STL class. ">std::string</a> of anything the user specified at the command line or in the config file as second part to the <code>"--value-type"</code> option (e.g., representing the name of the variable in the MATLAB data file containing the reference state density matrix).</li>
<li>You can load data from the MATLAB data file via the <code>"matf"</code> object, which is a <a class="el" href="class_tomographer_1_1_m_a_t_1_1_file.html">Tomographer::MAT::File</a> instance.</li>
<li>You may of course use any tool provided by Eigen and the <a class="el" href="namespace_tomographer.html" title="Base namespace for the Tomographer project. ">Tomographer</a> API, for example <a class="el" href="namespace_tomographer_1_1_math_tools.html#ab002df25ed2e9b3f52ee5eeaecbc27cf">Tomographer::Tools::forcePosSemiDef()</a> to ensure a matrix is positive semidefinite.</li>
</ul>
<p>In our example for the Hilbert-Schmidt distance, the reference state is read from the MATLAB data file. It is to be taken by default to be <code>"rho_MLE"</code>, which is the maximum likelihood estimate state, if <code>"--value-type=HS-dist"</code>. A custom reference state can be given which is to be read from the MATLAB data file (if <code>"--value-type=HS-dist:my_ref_state_dm"</code>, where <code>"my_ref_state_dm"</code> is the name of the variable inside the MATLAB data file containing the density matrix of the reference state). Here's the code for the non-multiplexed version of the value-calculator: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (opt-&gt;valtype.valtype == val_type_spec::HS_DIST) {</div><div class="line">  </div><div class="line">  MatrixType rho_ref(dmt.initMatrixType());</div><div class="line"></div><div class="line">  <span class="comment">// determine the variable name of the reference state. By default, &quot;rho_MLE&quot;.</span></div><div class="line">  <a class="codeRef" doxygen="/Users/philippe/Research/projects/tomographer/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/string/basic_string.html">std::string</a> refname = <span class="stringliteral">&quot;rho_MLE&quot;</span>;</div><div class="line">  <span class="keywordflow">if</span> (opt-&gt;valtype.ref_obj_name.size()) {</div><div class="line">    <span class="comment">// explicit reference state given in the command-line option</span></div><div class="line">    refname = opt-&gt;valtype.ref_obj_name;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// read the reference state from the MATLAB data file into the matrix &#39;rho_ref&#39;</span></div><div class="line">  rho_ref = Tomographer::MAT::value&lt;MatrixType&gt;(matf-&gt;var(refname));</div><div class="line"></div><div class="line">  <span class="comment">// make sure that all eigenvalues of rho_ref are positive.</span></div><div class="line">  rho_ref = <a class="code" href="namespace_tomographer_1_1_math_tools.html#ab002df25ed2e9b3f52ee5eeaecbc27cf">Tomographer::Tools::forcePosSemiDef</a>(rho_ref, 1e-12);</div><div class="line"></div><div class="line">  <span class="comment">// emit debug message; this is displayed in verbose mode</span></div><div class="line">  logger.debug(<span class="stringliteral">&quot;tomorun_dispatch()&quot;</span>, [&amp;](<a class="codeRef" doxygen="/Users/philippe/Research/projects/tomographer/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/io/basic_ostream.html">std::ostream</a> &amp; str) {</div><div class="line">      str &lt;&lt; <span class="stringliteral">&quot;Using HS distance figure of merit with rho_ref = \n&quot;</span></div><div class="line">          &lt;&lt; rho_ref &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line">    });</div><div class="line"></div><div class="line">  <span class="comment">// finally, dispatch the execution to the main function tomorun().</span></div><div class="line">  tomorun&lt;BinningAnalysisErrorBars&gt;(</div><div class="line">    <span class="comment">// first argument: the tomography problem data and types</span></div><div class="line">    tomodat,</div><div class="line">    <span class="comment">// second argument: the command-line options</span></div><div class="line">    opt,</div><div class="line">    <span class="comment">// thrid argument: an instance of the figure of merit calculator</span></div><div class="line">    HsDistToRefCalculator&lt;DMTypes&gt;(rho_ref),</div><div class="line">    <span class="comment">// fourth argument: the logger object to emit log messages</span></div><div class="line">    logger);</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!--
 * This file is part of the Tomographer project, which is distributed under the
 * terms of the MIT license.
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 ETH Zurich, Institute for Theoretical Physics, Philippe Faist
 * Copyright (c) 2017 Caltech, Institute for Quantum Information and Matter, Philippe Faist
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">%Tomographer C++ Framework: API Documentation</a></li>
    <li class="footer">Generated on Sat Apr 8 2017 16:47:58 for Tomographer by
    <a href="http://www.doxygen.org/index.html">
    Doxygen 1.8.12</a> </li>
  </ul>
</div>
<!-- and now, plug in our script to tweak the page: -->
<script type="text/javascript" src="tomographer_script_setup.js"></script>
</body>
</html>
